<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Quiz App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --border: #475569;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 28px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .upload-section {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: var(--accent);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .file-label:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .mode-selection, .topic-selection {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .mode-buttons, .topic-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .mode-btn, .topic-btn, .action-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn:hover, .topic-btn:hover, .action-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .quiz-container {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background: var(--bg-card);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-counter {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-small.btn-back {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-small.btn-back:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-small.btn-submit {
            background: var(--success);
            color: white;
        }

        .btn-small.btn-submit:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .timer {
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            color: var(--accent);
        }

        .question-text {
            font-size: 20px;
            margin-bottom: 25px;
            line-height: 1.6;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option {
            background: var(--bg-card);
            border: 2px solid var(--border);
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .option.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.2);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.2);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.2);
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .explanation {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--accent);
        }

        .explanation-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .quiz-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .results {
            text-align: center;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            margin: 30px 0;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .review-question {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .review-status {
            padding: 5px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .review-status.correct {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .review-status.incorrect {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
            }

            .question-text {
                font-size: 18px;
            }

            .mode-buttons {
                grid-template-columns: 1fr;
            }

            .quiz-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn-small {
                flex: 1;
            }
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <header>
            <h1>üéØ MCQ Quiz App</h1>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button id="newQuizBtn" class="theme-toggle hidden" onclick="triggerFileUpload()">üì§ Upload New CSV</button>
                <button class="theme-toggle" onclick="toggleTheme()">üåì Toggle Theme</button>
            </div>
        </header>

        <!-- Upload Section -->
        <div id="uploadSection" class="upload-section">
            <h2>Upload Your Quiz CSV</h2>
            <p style="color: var(--text-secondary); margin: 10px 0;">
                Expected columns: Question, Options, Correct Option, Explanation, Topic (optional)
            </p>
            
            <!-- CSV Format Guide -->
            <details style="margin: 20px 0; text-align: left;">
                <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: var(--bg-card); border-radius: 8px;">
                    üìã CSV Format Guide (Click to expand)
                </summary>
                <div style="margin-top: 15px; padding: 15px; background: var(--bg-card); border-radius: 8px; font-size: 14px;">
                    <p style="margin-bottom: 10px;"><strong>Required Columns:</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li><code>Question</code> - The question text</li>
                        <li><code>Options</code> - Answer choices separated by comma (,) or pipe (|)</li>
                        <li><code>Correct Option</code> - The exact text of the correct answer</li>
                        <li><code>Explanation</code> - Explanation for the answer</li>
                        <li><code>Topic</code> - (Optional) Category/topic name</li>
                    </ul>
                    
                    <p style="margin-bottom: 10px;"><strong>Example CSV Format:</strong></p>
                    <pre style="background: var(--bg-primary); padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 12px;">Question,Options,Correct Option,Explanation,Topic
What is 2+2?,2|3|4|5,4,Basic addition: 2+2=4,Mathematics
Capital of France?,London|Paris|Berlin|Rome,Paris,Paris is the capital city of France,Geography
Who wrote Hamlet?,Dickens|Shakespeare|Austen|Orwell,Shakespeare,William Shakespeare wrote Hamlet,Literature</pre>
                    
                    <p style="margin-top: 15px;"><strong>Tips:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Use either comma (,) or pipe (|) to separate options</li>
                        <li>Correct Option must exactly match one of the options</li>
                        <li>Topic column is optional but enables Topic-Wise Practice</li>
                        <li>Keep questions clear and concise</li>
                    </ul>
                    
                    <button class="btn btn-primary" onclick="downloadSampleCSV()" style="margin-top: 15px;">
                        ‚¨áÔ∏è Download Sample CSV
                    </button>
                </div>
            </details>
            
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="handleFileUpload(event)">
                <label for="csvFile" class="file-label">üìÅ Choose CSV File</label>
            </div>
            <p id="fileName" style="color: var(--text-secondary); margin-top: 10px;"></p>
            
            <div id="storedDataInfo" class="hidden" style="margin-top: 20px; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                <p style="color: var(--success); font-weight: 600; margin-bottom: 10px;">‚úÖ Previously loaded quiz data found!</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                    <span id="storedQuizInfo"></span>
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="useSavedData()">Use Saved Data</button>
                    <button class="btn btn-secondary" onclick="clearSavedData()">Clear & Upload New</button>
                </div>
            </div>
        </div>

        <!-- Mode Selection -->
        <div id="modeSelection" class="mode-selection hidden">
            <h2>Select Quiz Mode</h2>
            <div class="mode-buttons">
                <button class="mode-btn" onclick="selectMode('test')">
                    üìù Test Mode
                    <p style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Real exam simulation</p>
                </button>
                <button class="mode-btn" onclick="selectMode('practice')">
                    üìö Practice Mode
                    <p style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Learn with instant feedback</p>
                </button>
                <button class="mode-btn" onclick="selectMode('topic')">
                    üéØ Topic-Wise Practice
                    <p style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Focus on specific topics</p>
                </button>
            </div>
        </div>

        <!-- Timer Settings -->
        <div id="timerSettings" class="mode-selection hidden">
            <h2>‚è±Ô∏è Set Timer Duration</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Choose how much time you want for the quiz</p>
            
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Time per Question (minutes):</label>
                <input type="number" id="timePerQuestion" min="0.5" max="10" step="0.5" value="1" 
                       style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); 
                              background: var(--bg-card); color: var(--text-primary); font-size: 16px;">
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                    Total time: <span id="totalTimeDisplay">0</span> minutes
                </p>
            </div>

            <div class="checkbox-wrapper">
                <input type="checkbox" id="noTimerCheck">
                <label for="noTimerCheck">No timer (unlimited time)</label>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-primary" onclick="startQuizWithTimer()">Start Quiz</button>
                <button class="btn btn-secondary" onclick="backToModeSelection()">‚Üê Back</button>
            </div>
        </div>

        <!-- Topic Selection -->
        <div id="topicSelection" class="topic-selection hidden">
            <h2>Select Topic</h2>
            <div id="topicButtons" class="topic-buttons"></div>
            <button class="btn btn-secondary" style="margin-top: 15px;" onclick="backToModeSelection()">‚Üê Back</button>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="quiz-container hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>

            <div class="question-header">
                <span id="questionCounter" class="question-counter"></span>
                <div class="header-actions">
                    <span id="timer" class="timer hidden"></span>
                    <button class="btn-small btn-back" onclick="confirmBackToHome()">üè† Back</button>
                    <button class="btn-small btn-submit" onclick="confirmSubmitQuiz()">‚úÖ Submit</button>
                </div>
            </div>

            <div id="questionText" class="question-text"></div>

            <div id="options" class="options"></div>

            <div id="explanation" class="explanation hidden">
                <div class="explanation-title">üí° Explanation:</div>
                <div id="explanationText"></div>
            </div>

            <div class="quiz-actions">
                <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()">‚Üê Previous</button>
                <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">Next ‚Üí</button>
                <button id="submitBtn" class="btn btn-primary hidden" onclick="submitQuiz()">Submit Quiz</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="quiz-container hidden">
            <div class="results">
                <h2>üéâ Quiz Completed!</h2>
                <div class="score-display" id="scoreDisplay"></div>

                <div class="stats">
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-value" id="correctCount" style="color: var(--success);"></div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--error);">
                        <div class="stat-value" id="wrongCount" style="color: var(--error);"></div>
                        <div class="stat-label">Wrong</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--text-secondary);">
                        <div class="stat-value" id="skippedCount" style="color: var(--text-secondary);"></div>
                        <div class="stat-label">Skipped</div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="reviewAnswers()">üìã Review Answers</button>
                    <button id="retryWrongBtn" class="btn btn-primary hidden" onclick="retryWrongQuestions()">üîÑ Retry Wrong Questions</button>
                    <button class="btn btn-secondary" onclick="restartQuiz()">üè† Back to Home</button>
                </div>
            </div>
        </div>

        <!-- Review Section -->
        <div id="reviewSection" class="quiz-container hidden">
            <h2>üìã Answer Review</h2>
            <div id="reviewContent"></div>
            <button class="btn btn-secondary" style="margin-top: 20px;" onclick="backToResults()">‚Üê Back to Results</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let quizData = [];
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizMode = '';
        let timerInterval = null;
        let timeRemaining = 0;
        let wrongQuestions = [];
        
        const STORAGE_KEY = 'mcq_quiz_data';
        const STORAGE_TIMESTAMP_KEY = 'mcq_quiz_timestamp';

        // Check for saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkForSavedData();
            
            const timeInput = document.getElementById('timePerQuestion');
            const noTimerCheck = document.getElementById('noTimerCheck');
            
            if (timeInput) {
                timeInput.addEventListener('input', updateTotalTime);
            }
            
            if (noTimerCheck) {
                noTimerCheck.addEventListener('change', function() {
                    timeInput.disabled = this.checked;
                });
            }
        });

        function checkForSavedData() {
            try {
                const savedData = sessionStorage.getItem(STORAGE_KEY);
                const timestamp = sessionStorage.getItem(STORAGE_TIMESTAMP_KEY);
                
                if (savedData) {
                    const savedDate = new Date(parseInt(timestamp));
                    const questionCount = JSON.parse(savedData).length;
                    
                    document.getElementById('storedQuizInfo').innerHTML = 
                        `<strong>${questionCount} questions</strong> loaded on ${savedDate.toLocaleDateString()} at ${savedDate.toLocaleTimeString()}`;
                    document.getElementById('storedDataInfo').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error checking saved data:', e);
            }
        }

        function useSavedData() {
            try {
                const savedData = sessionStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    quizData = JSON.parse(savedData);
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('modeSelection').classList.remove('hidden');
                    showNewQuizButton();
                }
            } catch (e) {
                alert('Error loading saved data. Please upload a new CSV file.');
                clearSavedData();
            }
        }

        function clearSavedData() {
            sessionStorage.removeItem(STORAGE_KEY);
            sessionStorage.removeItem(STORAGE_TIMESTAMP_KEY);
            document.getElementById('storedDataInfo').classList.add('hidden');
            document.getElementById('fileName').textContent = '';
        }

        function showNewQuizButton() {
            document.getElementById('newQuizBtn').classList.remove('hidden');
        }

        function hideNewQuizButton() {
            document.getElementById('newQuizBtn').classList.add('hidden');
        }

        function triggerFileUpload() {
            // Directly open file picker
            document.getElementById('csvFile').click();
        }

        function loadNewQuiz() {
            if (confirm('Are you sure you want to load a new quiz? Current data will be cleared.')) {
                // Clear all data
                quizData = [];
                currentQuiz = [];
                currentQuestionIndex = 0;
                userAnswers = [];
                wrongQuestions = [];
                quizMode = '';
                if (timerInterval) clearInterval(timerInterval);
                timeRemaining = 0;
                
                clearSavedData();
                hideNewQuizButton();
                
                // Show upload section
                document.getElementById('modeSelection').classList.add('hidden');
                document.getElementById('timerSettings').classList.add('hidden');
                document.getElementById('topicSelection').classList.add('hidden');
                document.getElementById('quizContainer').classList.add('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('reviewSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
            }
        }

        function saveQuizData(data) {
            try {
                sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                sessionStorage.setItem(STORAGE_TIMESTAMP_KEY, Date.now().toString());
            } catch (e) {
                console.warn('Unable to save quiz data to session storage:', e);
            }
        }

        function downloadSampleCSV() {
            const sampleData = `Question,Options,Correct Option,Explanation,Topic
What is 2+2?,2|3|4|5,4,Basic addition: 2+2=4,Mathematics
What is the capital of France?,London|Paris|Berlin|Rome,Paris,Paris is the capital and largest city of France,Geography
Who wrote Romeo and Juliet?,Charles Dickens|William Shakespeare|Jane Austen|Mark Twain,William Shakespeare,Romeo and Juliet is a tragedy written by William Shakespeare,Literature
What is H2O?,Oxygen|Hydrogen|Water|Carbon Dioxide,Water,H2O is the chemical formula for water,Science
What is 10 * 5?,45|50|55|60,50,Basic multiplication: 10 * 5 = 50,Mathematics`;

            const blob = new Blob([sampleData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_quiz.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            body.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Ask for confirmation if data already exists
            if (quizData.length > 0) {
                if (!confirm('Loading a new CSV will replace current quiz data. Continue?')) {
                    event.target.value = ''; // Reset file input
                    return;
                }
            }

            // Clear existing data
            quizData = [];
            currentQuiz = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            wrongQuestions = [];
            quizMode = '';
            if (timerInterval) clearInterval(timerInterval);

            document.getElementById('fileName').textContent = `Loaded: ${file.name}`;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    quizData = results.data.map((row, index) => {
                        const optionsRaw = row.Options || row.options || '';
                        const optionsSeparator = optionsRaw.includes('|') ? '|' : ',';
                        const options = optionsRaw.split(optionsSeparator).map(opt => opt.trim()).filter(opt => opt);
                        
                        return {
                            id: index,
                            question: row.Question || row.question || '',
                            options: options,
                            correctOption: (row['Correct Option'] || row['correct option'] || '').trim(),
                            explanation: row.Explanation || row.explanation || '',
                            topic: row.Topic || row.topic || 'General'
                        };
                    }).filter(q => q.question && q.options.length > 0 && q.correctOption);

                    if (quizData.length === 0) {
                        alert('No valid questions found in the CSV file. Please check the format.');
                        return;
                    }

                    // Save to session storage
                    saveQuizData(quizData);

                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('modeSelection').classList.remove('hidden');
                    showNewQuizButton();
                }
            });
        }

        function selectMode(mode) {
            quizMode = mode;
            
            if (mode === 'topic') {
                showTopicSelection();
            } else if (mode === 'test') {
                showTimerSettings();
            } else {
                startQuiz();
            }
        }

        function showTimerSettings() {
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('timerSettings').classList.remove('hidden');
            updateTotalTime();
        }

        function updateTotalTime() {
            const timePerQ = parseFloat(document.getElementById('timePerQuestion').value) || 1;
            const totalMinutes = Math.round(timePerQ * quizData.length);
            document.getElementById('totalTimeDisplay').textContent = totalMinutes;
        }

        function startQuizWithTimer() {
            const noTimer = document.getElementById('noTimerCheck').checked;
            const timePerQ = parseFloat(document.getElementById('timePerQuestion').value) || 1;
            
            if (!noTimer) {
                timeRemaining = Math.round(timePerQ * quizData.length * 60); // Convert to seconds
            }
            
            document.getElementById('timerSettings').classList.add('hidden');
            startQuiz();
        }

        function showTopicSelection() {
            const topics = [...new Set(quizData.map(q => q.topic))];
            const topicButtons = document.getElementById('topicButtons');
            topicButtons.innerHTML = '';

            topics.forEach(topic => {
                const count = quizData.filter(q => q.topic === topic).length;
                const btn = document.createElement('button');
                btn.className = 'topic-btn';
                btn.innerHTML = `${topic}<p style="font-size: 12px; margin-top: 8px; opacity: 0.8;">${count} questions</p>`;
                btn.onclick = () => startTopicQuiz(topic);
                topicButtons.appendChild(btn);
            });

            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('topicSelection').classList.remove('hidden');
        }

        function startTopicQuiz(topic) {
            currentQuiz = quizData.filter(q => q.topic === topic);
            shuffleArray(currentQuiz);
            currentQuiz.forEach(q => q.options = shuffleArray([...q.options]));
            
            document.getElementById('topicSelection').classList.add('hidden');
            initializeQuiz();
        }

        function backToModeSelection() {
            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('timerSettings').classList.add('hidden');
            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function startQuiz(questionsToUse = null) {
            currentQuiz = questionsToUse || [...quizData];
            shuffleArray(currentQuiz);
            currentQuiz.forEach(q => q.options = shuffleArray([...q.options]));
            
            document.getElementById('modeSelection').classList.add('hidden');
            initializeQuiz();
        }

        function initializeQuiz() {
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuiz.length).fill(null);
            wrongQuestions = [];

            if (quizMode === 'test' && timeRemaining > 0) {
                startTimer();
            }

            document.getElementById('quizContainer').classList.remove('hidden');
            displayQuestion();
        }

        function startTimer() {
            const timerElement = document.getElementById('timer');
            timerElement.classList.remove('hidden');
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerElement.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                }
            }, 1000);
        }

        function displayQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / currentQuiz.length) * 100;
            
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('questionCounter').textContent = `Question ${currentQuestionIndex + 1} of ${currentQuiz.length}`;
            document.getElementById('questionText').textContent = question.question;
            
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                
                const isSelected = userAnswers[currentQuestionIndex] === option;
                if (isSelected) optionDiv.classList.add('selected');
                
                optionDiv.innerHTML = `
                    <span style="font-weight: bold; min-width: 25px;">${String.fromCharCode(65 + index)}.</span>
                    <span>${option}</span>
                `;
                
                optionDiv.onclick = () => selectOption(option, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('explanation').classList.add('hidden');
            
            document.getElementById('prevBtn').style.display = currentQuestionIndex === 0 ? 'none' : 'block';
            document.getElementById('nextBtn').classList.toggle('hidden', currentQuestionIndex === currentQuiz.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', currentQuestionIndex !== currentQuiz.length - 1);
        }

        function selectOption(option, optionDiv) {
            const question = currentQuiz[currentQuestionIndex];
            
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });
            
            optionDiv.classList.add('selected');
            userAnswers[currentQuestionIndex] = option;
            
            if (quizMode === 'practice') {
                // Show immediate feedback in practice mode
                const isCorrect = option === question.correctOption;
                
                if (isCorrect) {
                    optionDiv.classList.add('correct');
                } else {
                    optionDiv.classList.add('incorrect');
                    // Highlight correct answer
                    document.querySelectorAll('.option').forEach(opt => {
                        const optText = opt.querySelector('span:last-child').textContent;
                        if (optText === question.correctOption) {
                            opt.classList.add('correct');
                        }
                    });
                }
                
                // Disable further selection
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.add('disabled');
                    opt.onclick = null;
                });
                
                // Show explanation
                showExplanation();
            }
        }

        function showExplanation() {
            const question = currentQuiz[currentQuestionIndex];
            if (question.explanation) {
                document.getElementById('explanationText').textContent = question.explanation;
                document.getElementById('explanation').classList.remove('hidden');
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function submitQuiz() {
            if (timerInterval) clearInterval(timerInterval);
            
            let correct = 0;
            let wrong = 0;
            let skipped = 0;
            
            currentQuiz.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                if (!userAnswer) {
                    skipped++;
                } else if (userAnswer === question.correctOption) {
                    correct++;
                } else {
                    wrong++;
                    wrongQuestions.push(question);
                }
            });
            
            const score = Math.round((correct / currentQuiz.length) * 100);
            
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            document.getElementById('scoreDisplay').textContent = `${score}%`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('skippedCount').textContent = skipped;
            
            // Show retry button only in practice mode if there are wrong answers
            if (quizMode === 'practice' && wrongQuestions.length > 0) {
                document.getElementById('retryWrongBtn').classList.remove('hidden');
            }
        }

        function confirmSubmitQuiz() {
            const unanswered = userAnswers.filter(a => a === null).length;
            let message = 'Are you sure you want to submit the quiz?';
            
            if (unanswered > 0) {
                message = `You have ${unanswered} unanswered question(s). Do you still want to submit?`;
            }
            
            if (confirm(message)) {
                submitQuiz();
            }
        }

        function confirmBackToHome() {
            if (confirm('Are you sure you want to go back? Your current progress will be lost.')) {
                restartQuiz();
            }
        }

        function reviewAnswers() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.remove('hidden');
            
            const reviewContent = document.getElementById('reviewContent');
            reviewContent.innerHTML = '';
            
            currentQuiz.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correctOption;
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'review-question';
                reviewDiv.innerHTML = `
                    <div class="review-header">
                        <strong>Q${index + 1}. ${question.question}</strong>
                        <span class="review-status ${isCorrect ? 'correct' : 'incorrect'}">
                            ${isCorrect ? '‚úÖ Correct' : '‚ùå Wrong'}
                        </span>
                    </div>
                    <p style="margin: 10px 0;"><strong>Your Answer:</strong> ${userAnswer || 'Not answered'}</p>
                    <p style="margin: 10px 0; color: var(--success);"><strong>Correct Answer:</strong> ${question.correctOption}</p>
                    ${question.explanation ? `<p style="margin: 10px 0; padding: 10px; background: var(--bg-card); border-radius: 6px;"><strong>üí° Explanation:</strong> ${question.explanation}</p>` : ''}
                `;
                reviewContent.appendChild(reviewDiv);
            });
        }

        function backToResults() {
            document.getElementById('reviewSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function retryWrongQuestions() {
            quizMode = 'practice';
            startQuiz(wrongQuestions);
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function restartQuiz() {
            // Clear current quiz state but keep the data
            currentQuiz = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            wrongQuestions = [];
            quizMode = '';
            if (timerInterval) clearInterval(timerInterval);
            timeRemaining = 0;
            
            // Go back to mode selection
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('timerSettings').classList.add('hidden');
            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
    </script>
</body>
</html>